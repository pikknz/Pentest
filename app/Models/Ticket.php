<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Ticket extends Model
{
    use HasFactory;
    protected $table = 'tickets';
    public static function topUserName(): string
    {
        return 'Noel';
    }

    public static function getLastTicketProcessingTime(): string
    {
        return Ticket::select('updated_at')->orderBy('updated_at','DESC')->limit(1)->get();
    }

    public static function getClosedTickets(): string
    {
        return Ticket::where('status', '=', 1)->get();
    }

    public static function getUserTicketsByEmail($email): string
    {
        return Ticket::where('userEmail', '=', $email)->get();
    }

    public static function getOpenTickets(): string
    {
        return Ticket::where('status', '=', 0)->get();
    }

    public static function getOpenTicketCount(): string
    {
        return count(Ticket::where('status', '=', 0)->get());
    }

    public static function getTotalTicketCount(): string
    {
        return count(Ticket::all());
    }

    public static function getTopUserName(): string
    {
        return Ticket::select('userName', \DB::raw("COUNT('userEmail') AS ticket_count"))
            ->orderBy('ticket_count', 'desc')
            ->groupBy('userEmail','userName')
            ->first()['userName'];
    }

    public static function getStats(): string
    {
        $stats = [];
        $stats['totalTickets'] = Ticket::getTotalTicketCount();
        $stats['unprocessedTickets'] = Ticket::getOpenTicketCount();
        $stats['topUserName'] = Ticket::getTopUserName();
        $stats['lastTicketProcessingTime'] = Ticket::getLastTicketProcessingTime();
        return $stats;
    }
}
