<?php

namespace App\Models;

use App\Http\Controllers\TicketController;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Collection;

class Ticket extends Model
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'tickets';

    /**
     * Returns last time a ticket was processed
     * @return string
     */
    public static function getLastTicketProcessingTime(): string
    {
        $ticket = Ticket::select('updated_at')->orderBy('updated_at','DESC')->limit(1)->get();
        if(isset($ticket[0]['updated_at']))return $ticket[0]['updated_at'];
        return '';
    }

    /**
     * Open tickets have not been processed yet
     * @return Collection
     */
    public static function getOpenTickets(): Collection
    {
        return Ticket::where('status', '=', 0)->get();
    }

    /**
     * Closed tickets have been processed
     * @return Collection
     */
    public static function getClosedTickets(): Collection
    {
        return Ticket::where('status', '=', 1)->get();
    }

    /**
     * Users are identified by their email rather than id
     * @param string $email
     * @return string
     */
    public static function getUserTicketsByEmail(string $email): array
    {
        return Ticket::where('userEmail', '=', $email)->get();
    }

    /**
     * Count of un-processed tickets
     * @return int
     */
    public static function getOpenTicketCount(): int
    {
        return count(Ticket::where('status', '=', 0)->get());
    }

    /**
     * All tickets processed ot not count
     * @return int
     */
    public static function getTotalTicketCount(): int
    {
        return count(Ticket::all());
    }

    /**
     * Name of the user with the most tickets
     * @return string
     */
    public static function getTopUserName(): string
    {
        $ticket = Ticket::select('userName', \DB::raw("COUNT('userEmail') AS ticket_count"))
            ->orderBy('ticket_count', 'desc')
            ->groupBy('userEmail','userName')
            ->first();
        if(isset($ticket['userName']))return $ticket['userName'];
        return '';
    }

    /**
     * Put the stats into an array
     * @return string
     */
    public static function getStats(): array
    {
        $stats = [];
        $stats['totalTickets'] = Ticket::getTotalTicketCount();
        $stats['unprocessedTickets'] = Ticket::getOpenTicketCount();
        $stats['topUserName'] = Ticket::getTopUserName();
        $stats['lastTicketProcessingTime'] = Ticket::getLastTicketProcessingTime();
        return $stats;
    }
    public static function createTickets($count): int
    {
        if(!is_int($count)) throw new \Exception();
        try {
            Ticket::factory()->count($count)->create();
        } catch (\Exception $e) {
            return 0;
        }
        return 1;
    }

    public static function createTicketsSpecificUser(string $userName, string $userEmail, int $count): int
    {
        try {
            Ticket::factory()->count($count)->create([
                'userName' => $userName,
                'userEmail' => $userEmail
            ]);
        } catch (\Exception $e) {
            return 0;
        }
        return 1;
    }

    public static function processTickets(int $count): int
    {
        try {
            $ticketsToBeProcessed = Ticket::orderBy('created_at', 'DESC')->limit($count)->get();
            foreach ($ticketsToBeProcessed as $ticket) {
                $ticket->status = TicketController::TICKET_PROCESSED;
                $ticket->save();
            }
        }catch (\Exception $e) {
            return 0;
        }
        return 1;
    }
}
